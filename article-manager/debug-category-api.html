<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»APIè°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005f99;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .api-result {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>ğŸ” åˆ†ç±»APIè°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h3 class="debug-title">ğŸ“‹ è®¤è¯çŠ¶æ€æ£€æŸ¥</h3>
        <div id="auth-status"></div>
        <button onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
        <button onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•</button>
    </div>

    <div class="debug-section">
        <h3 class="debug-title">ğŸŒ åˆ†ç±»APIæµ‹è¯•</h3>
        <div class="test-grid">
            <div>
                <h4>è·å–åˆ†ç±»æ ‘ (æ ¹èŠ‚ç‚¹)</h4>
                <button onclick="testCategoryTree(0)">æµ‹è¯• /categories/tree/0</button>
                <div id="tree-result" class="api-result"></div>
            </div>
            <div>
                <h4>è·å–æ‰€æœ‰åˆ†ç±»</h4>
                <button onclick="testGetCategories()">æµ‹è¯• /categories/</button>
                <div id="categories-result" class="api-result"></div>
            </div>
            <div>
                <h4>åˆ›å»ºæµ‹è¯•åˆ†ç±»</h4>
                <button onclick="testCreateCategory()">æµ‹è¯•åˆ›å»ºåˆ†ç±»</button>
                <div id="create-result" class="api-result"></div>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h3 class="debug-title">ğŸ”§ ç½‘ç»œè¯·æ±‚è°ƒè¯•</h3>
        <div id="network-debug"></div>
        <button onclick="testNetworkConnectivity()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
    </div>

    <script type="module">
        // å¯¼å…¥APIå‡½æ•°
        import { categoryAPI, authAPI } from './src/services/api.js';
        
        // å°†APIå‡½æ•°æŒ‚è½½åˆ°windowå¯¹è±¡ï¼Œä¾›HTMLä¸­çš„äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨
        window.categoryAPI = categoryAPI;
        window.authAPI = authAPI;
        
        // å…¨å±€å˜é‡
        let debugInfo = {
            authStatus: {},
            apiResults: {}
        };
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.checkAuthStatus = function() {
            const statusDiv = document.getElementById('auth-status');
            
            try {
                const userId = localStorage.getItem('userId');
                const user = localStorage.getItem('user');
                const accessToken = localStorage.getItem('accessToken');
                const refreshToken = localStorage.getItem('refreshToken');
                
                debugInfo.authStatus = {
                    userId,
                    user,
                    accessToken,
                    refreshToken,
                    hasUserId: !!userId,
                    timestamp: new Date().toISOString()
                };
                
                let html = '<h4>ğŸ“Š LocalStorage çŠ¶æ€:</h4>';
                
                if (!userId) {
                    html += '<div class="status error">âŒ æœªæ‰¾åˆ° userId - ç”¨æˆ·å¯èƒ½æœªç™»å½•</div>';
                } else {
                    html += `<div class="status success">âœ… userId: ${userId}</div>`;
                }
                
                if (user) {
                    try {
                        const userObj = JSON.parse(user);
                        html += `<div class="status info">ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${userObj.username || userObj.email || 'æœªçŸ¥'}</div>`;
                    } catch (e) {
                        html += `<div class="status warning">âš ï¸ ç”¨æˆ·ä¿¡æ¯æ ¼å¼é”™è¯¯: ${user}</div>`;
                    }
                }
                
                html += '<div class="code">' + JSON.stringify(debugInfo.authStatus, null, 2) + '</div>';
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥: ${error.message}</div>`;
            }
        };
        
        // æ¨¡æ‹Ÿç™»å½•
        window.simulateLogin = function() {
            const testUserId = 'test-user-' + Date.now();
            const testUser = {
                userId: testUserId,
                username: 'testuser',
                email: 'test@example.com'
            };
            
            localStorage.setItem('userId', testUserId);
            localStorage.setItem('user', JSON.stringify(testUser));
            
            document.getElementById('auth-status').innerHTML = 
                '<div class="status success">âœ… å·²è®¾ç½®æµ‹è¯•ç”¨æˆ·ID: ' + testUserId + '</div>';
        };
        
        // æµ‹è¯•åˆ†ç±»æ ‘API
        window.testCategoryTree = async function(categoryId = 0) {
            const resultDiv = document.getElementById('tree-result');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•åˆ†ç±»æ ‘API...</div>';
            
            try {
                console.log('ğŸ§ª æµ‹è¯•åˆ†ç±»æ ‘APIï¼ŒcategoryId:', categoryId);
                
                // æ£€æŸ¥è®¤è¯
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    throw new Error('æœªæ‰¾åˆ°userIdï¼Œè¯·å…ˆæ¨¡æ‹Ÿç™»å½•');
                }
                
                // ç›´æ¥è°ƒç”¨fetchæµ‹è¯•
                const response = await fetch(`/api/v1/categories/tree/${categoryId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': userId
                    }
                });
                
                console.log('ğŸ“¡ åˆ†ç±»æ ‘APIå“åº”çŠ¶æ€:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (parseError) {
                    responseData = { raw: responseText };
                }
                
                const result = {
                    success: response.ok,
                    url: `/categories/tree/${categoryId}`,
                    status: response.status,
                    statusText: response.statusText,
                    response: responseData,
                    timestamp: new Date().toISOString()
                };
                
                debugInfo.apiResults.categoryTree = result;
                
                if (response.ok) {
                    let categoriesCount = 0;
                    if (Array.isArray(responseData)) {
                        categoriesCount = responseData.length;
                    } else if (responseData.data && Array.isArray(responseData.data)) {
                        categoriesCount = responseData.data.length;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… åˆ†ç±»æ ‘APIè°ƒç”¨æˆåŠŸ</div>
                        <p><strong>åˆ†ç±»æ•°é‡:</strong> ${categoriesCount}</p>
                        <div class="code">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">âŒ åˆ†ç±»æ ‘APIè°ƒç”¨å¤±è´¥ (${response.status})</div>
                        <div class="code">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
                
                console.log('âœ… åˆ†ç±»æ ‘APIæµ‹è¯•å®Œæˆ:', result);
                
            } catch (error) {
                const result = {
                    success: false,
                    url: `/categories/tree/${categoryId}`,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
                
                debugInfo.apiResults.categoryTree = result;
                
                resultDiv.innerHTML = `
                    <div class="status error">âŒ åˆ†ç±»æ ‘APIè°ƒç”¨å¼‚å¸¸</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                `;
                
                console.error('âŒ åˆ†ç±»æ ‘APIæµ‹è¯•å¤±è´¥:', error);
            }
        };
        
        // æµ‹è¯•è·å–æ‰€æœ‰åˆ†ç±»
        window.testGetCategories = async function() {
            const resultDiv = document.getElementById('categories-result');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•è·å–åˆ†ç±»API...</div>';
            
            try {
                console.log('ğŸ§ª æµ‹è¯•è·å–æ‰€æœ‰åˆ†ç±»API');
                const response = await categoryAPI.getCategories();
                
                const result = {
                    success: true,
                    url: '/categories/',
                    response: response,
                    timestamp: new Date().toISOString()
                };
                
                debugInfo.apiResults.getCategories = result;
                
                resultDiv.innerHTML = `
                    <div class="status success">âœ… è·å–åˆ†ç±»APIè°ƒç”¨æˆåŠŸ</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                `;
                
                console.log('âœ… è·å–åˆ†ç±»APIæµ‹è¯•æˆåŠŸ:', response);
                
            } catch (error) {
                const result = {
                    success: false,
                    url: '/categories/',
                    error: error.message,
                    response: error.response?.data,
                    status: error.response?.status,
                    timestamp: new Date().toISOString()
                };
                
                debugInfo.apiResults.getCategories = result;
                
                resultDiv.innerHTML = `
                    <div class="status error">âŒ è·å–åˆ†ç±»APIè°ƒç”¨å¤±è´¥</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                `;
                
                console.error('âŒ è·å–åˆ†ç±»APIæµ‹è¯•å¤±è´¥:', error);
            }
        };
        
        // æµ‹è¯•åˆ›å»ºåˆ†ç±»
        window.testCreateCategory = async function() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•åˆ›å»ºåˆ†ç±»API...</div>';
            
            try {
                const testCategory = {
                    name: 'æµ‹è¯•åˆ†ç±»-' + Date.now(),
                    parentId: 0
                };
                
                console.log('ğŸ§ª æµ‹è¯•åˆ›å»ºåˆ†ç±»APIï¼Œæ•°æ®:', testCategory);
                const response = await categoryAPI.createCategory(testCategory);
                
                const result = {
                    success: true,
                    url: '/categories',
                    requestData: testCategory,
                    response: response,
                    timestamp: new Date().toISOString()
                };
                
                debugInfo.apiResults.createCategory = result;
                
                resultDiv.innerHTML = `
                    <div class="status success">âœ… åˆ›å»ºåˆ†ç±»APIè°ƒç”¨æˆåŠŸ</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                `;
                
                console.log('âœ… åˆ›å»ºåˆ†ç±»APIæµ‹è¯•æˆåŠŸ:', response);
                
            } catch (error) {
                const result = {
                    success: false,
                    url: '/categories',
                    error: error.message,
                    response: error.response?.data,
                    status: error.response?.status,
                    timestamp: new Date().toISOString()
                };
                
                debugInfo.apiResults.createCategory = result;
                
                resultDiv.innerHTML = `
                    <div class="status error">âŒ åˆ›å»ºåˆ†ç±»APIè°ƒç”¨å¤±è´¥</div>
                    <div class="code">${JSON.stringify(result, null, 2)}</div>
                `;
                
                console.error('âŒ åˆ›å»ºåˆ†ç±»APIæµ‹è¯•å¤±è´¥:', error);
            }
        };
        
        // æµ‹è¯•ç½‘ç»œè¿æ¥
        window.testNetworkConnectivity = async function() {
            const debugDiv = document.getElementById('network-debug');
            debugDiv.innerHTML = '<div class="status info">ğŸ”„ æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿æ¥...</div>';
            
            try {
                // æµ‹è¯•åŸºç¡€è¿æ¥
                const baseURL = '/api/v1';
                const testURL = `${baseURL}/categories/tree/0`;
                
                console.log('ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥åˆ°:', testURL);
                
                const response = await fetch(testURL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': localStorage.getItem('userId') || 'test-user'
                    }
                });
                
                const responseData = await response.text();
                
                const result = {
                    url: testURL,
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData,
                    timestamp: new Date().toISOString()
                };
                
                if (response.ok) {
                    debugDiv.innerHTML = `
                        <div class="status success">âœ… ç½‘ç»œè¿æ¥æ­£å¸¸</div>
                        <div class="code">${JSON.stringify(result, null, 2)}</div>
                    `;
                } else {
                    debugDiv.innerHTML = `
                        <div class="status warning">âš ï¸ æœåŠ¡å™¨å“åº”å¼‚å¸¸ (${response.status})</div>
                        <div class="code">${JSON.stringify(result, null, 2)}</div>
                    `;
                }
                
            } catch (error) {
                debugDiv.innerHTML = `
                    <div class="status error">âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ${error.message}</div>
                    <div class="code">${JSON.stringify({
                        error: error.message,
                        timestamp: new Date().toISOString()
                    }, null, 2)}</div>
                `;
            }
        };
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });
        
        // å¯¼å‡ºè°ƒè¯•ä¿¡æ¯åˆ°å…¨å±€
        window.getDebugInfo = function() {
            return debugInfo;
        };
        
        console.log('ğŸ” åˆ†ç±»APIè°ƒè¯•å·¥å…·å·²åŠ è½½');
        console.log('ğŸ’¡ ä½¿ç”¨ getDebugInfo() è·å–æ‰€æœ‰è°ƒè¯•ä¿¡æ¯');
    </script>
</body>
</html>
